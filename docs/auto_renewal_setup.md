# Настройка автоматического продления подписок

## Обзор функционала

Система автоматического продления подписок позволяет:
- Автоматически продлевать подписки за день до истечения
- Управлять автопродлением через команду `/subscription`
- Отменять подписку с сохранением доступа до конца оплаченного периода
- Отслеживать статус всех подписок через утилиту управления

## Миграция базы данных

Перед использованием автопродления необходимо выполнить миграцию БД:

```bash
# Для локальной SQLite базы
python database/migrations/add_auto_renewal_fields.py

# Для PostgreSQL/MySQL на сервере
export DATABASE_URL="postgresql://user:pass@host:port/dbname"
python database/migrations/add_auto_renewal_fields.py
```

## Настройка ЮKassa для рекуррентных платежей

1. В личном кабинете ЮKassa включите опцию "Рекуррентные платежи"
2. Настройте webhook для получения уведомлений о платежах:
   - URL: `https://ваш-домен.com/webhook/payment`
   - События: `payment.succeeded`, `payment.canceled`

## Управление подписками

### Для пользователей

- `/subscription` - просмотр статуса подписки и управление автопродлением
- Кнопка "Включить/Отключить автопродление" - управление автопродлением
- Кнопка "Отменить подписку" - отмена с сохранением доступа до конца периода

### Для администраторов

Запустите утилиту управления:

```bash
python utils/check_subscriptions.py
```

Доступные функции:
1. Просмотр истекающих подписок
2. Принудительный запуск проверки и продления
3. Просмотр всех активных подписок

## Автоматическая проверка

Сервис автопродления запускается автоматически при старте бота и проверяет подписки каждый час.

### Логика продления:
1. За 24 часа до истечения подписки система пытается создать рекуррентный платеж
2. Если сохранен метод оплаты - платеж проходит автоматически
3. Если нет - пользователю отправляется уведомление с ссылкой на оплату
4. При 3 неудачных попытках пользователь получает уведомление об отключении автопродления

## Мониторинг

Проверьте логи для отслеживания работы автопродления:

```bash
# Фильтр логов по автопродлению
grep "автопродлен" bot.log

# Просмотр ошибок
grep "ERROR.*renewal" bot.log
```

## Тестирование

Для тестирования автопродления:

1. Создайте тестовую подписку с коротким сроком:
   ```python
   # В config.py временно установите
   SUBSCRIPTION_DAYS = 1  # 1 день для теста
   ```

2. Запустите принудительную проверку через утилиту

3. Проверьте получение уведомлений и создание платежей

## Безопасность

- Все платежные данные хранятся только в ЮKassa
- В БД хранятся только ID платежей
- Рекуррентные платежи требуют явного согласия пользователя
- Пользователь может отключить автопродление в любой момент 