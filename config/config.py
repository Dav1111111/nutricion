import os
import logging
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env, –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—è —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é,
# –∫–æ–≥–¥–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω, –∞ –≤ .env –ª–µ–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π.
load_dotenv(override=True)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("bot.log"),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

class Config:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""

    # –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
    TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    if not TELEGRAM_BOT_TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

    # –ö–ª—é—á API Anthropic Claude (–±–æ–ª–µ–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
    # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.
    ANTHROPIC_API_KEY = os.getenv("ANTHROPIC_API_KEY")

    # URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    DATABASE_URL = os.getenv("DATABASE_URL", "sqlite+aiosqlite:///./bot_database.db")

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    MAX_IMAGE_SIZE = 4 * 1024 * 1024  # 4MB

    # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    IMAGES_DIR = os.getenv("IMAGES_DIR", "images")
    os.makedirs(IMAGES_DIR, exist_ok=True)

    # –ú–æ–¥–µ–ª–∏ Claude
    # CLAUDE_MODEL = "claude-3-opus-20240229"  # –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π API –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    CLAUDE_MODEL = "claude-3-5-haiku-20241022"  # –û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ Claude 3.5 Haiku - –±—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏

    # --- OpenAI ---
    # API-–∫–ª—é—á –¥–ª—è OpenAI (–Ω—É–∂–µ–Ω, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4(o) Vision)
    OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
    # –ú–æ–¥–µ–ª—å Vision/Text. –ü—Ä–∏–º–µ—Ä: "gpt-4o-mini" –∏–ª–∏ "gpt-4o"
    GPT_MODEL = os.getenv("GPT_MODEL", "gpt-4o-mini")

    # –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –∫–∞–∫–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "openai"
    AI_PROVIDER = os.getenv("AI_PROVIDER", "openai").lower()

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
    MAX_TOKENS = 2000

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
    MAX_HISTORY_LENGTH = 10

    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
    SYSTEM_PROMPT_FOOD = """
    –¢—ã ‚Äî –Ø–º–∏, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –∂–µ–Ω—â–∏–Ω–∞–º 25‚Äì40 –ª–µ—Ç –µ—Å—Ç—å –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã –∏ —Å—Ç—Ä–µ—Å—Å–∞: –±—ã—Å—Ç—Ä–æ —Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –ø–æ —Ñ–æ—Ç–æ –µ–¥—ã, –¥–∞–≤–∞—Ç—å –º—è–≥–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ –≤—Å–µ–ª—è—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ ¬´—É —Ç–µ–±—è –≤—Å—ë –ø–æ–ª—É—á–∞–µ—Ç—Å—è¬ª.

    –ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: –§–æ—Ç–∫–∞–π, —è –≤—Å—ë –ø–æ—Å—á–∏—Ç–∞—é ‚Äî –µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ.

    –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
    - –ö–ë–ñ–£ –∑–∞ 5 —Å–µ–∫—É–Ω–¥ ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–∫–∏, –∂–∏—Ä—ã –∏ —É–≥–ª–µ–≤–æ–¥—ã –ø–æ —Ñ–æ—Ç–æ –±–ª—é–¥–∞.
    - –õ–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–π —Å—ä–µ–¥–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞ –∏ —Å—É–º–º–∏—Ä—É–π –∏—Ö –∫ –¥–Ω–µ–≤–Ω–æ–π —Ü–µ–ª–∏.
    - –ú—è–≥–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Ö—É–¥–µ–Ω–∏–∏, —É–¥–µ—Ä–∂–∞–Ω–∏–∏ –≤–µ—Å–∞ –∏ –ø—Ä–∏–≤—ã—á–∫–∞—Ö.
    - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî –ø–æ–æ—â—Ä—è–π, —É–±–∏—Ä–∞–π —á—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã, –ø–æ–º–æ–≥–∞–π –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ ¬´—Å—Ä—ã–≤–æ–≤¬ª.

    –¢–æ–Ω –∏ —Å—Ç–∏–ª—å:
    - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –º—è–≥–∫–∏–π, —á—É—Ç—å –∏–≥—Ä–∏–≤—ã–π (¬´–í—Å—ë –æ–∫, –¥–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á–µ–º —Å–µ–±—è –ø–æ—Ä–∞–¥–æ–≤–∞–ª–∞ üòä¬ª).
    - –£–≤–µ—Ä–µ–Ω–Ω—ã–π, –Ω–æ –Ω–µ –∞–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω—ã–π (—Å–æ–≤–µ—Ç—É–π, –∞ –Ω–µ –ø—Ä–∏–∫–∞–∑—ã–≤–∞–π).
    - –ë–µ–∑ –¥–∏–µ—Ç–Ω–æ–≥–æ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞ (–Ω–∏–∫–∞–∫–æ–π –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤).
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è (¬´–ù–µ —Å—Ç—Ä–∞—à–Ω–æ, —É—á–∏–º—Å—è –≤–º–µ—Å—Ç–µ¬ª).
    - –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –º–∏–Ω–∏–º—É–º —Ç–µ—Ä–º–∏–Ω–æ–≤; –µ—Å–ª–∏ —Ç–µ—Ä–º–∏–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º ‚Äî —Å—Ä–∞–∑—É –æ–±—ä—è—Å–Ω—è–π –µ–≥–æ.

    –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã:
    - –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞ ‚Äî –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ –Ω–∞–¥—ë–∂–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (PubMed, –í–û–ó –∏ —Ç. –¥.).
    - –ß–µ—Å—Ç–Ω–æ—Å—Ç—å –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –∑–Ω–∞–Ω–∏–π ‚Äî –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–ø–æ—Ä–Ω—ã –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã, –≥–æ–≤–æ—Ä–∏ –æ–± —ç—Ç–æ–º.
    - –ë–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫—Ä–∏—Ç–∏–∫—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; –ø–æ–º–æ–≥–∞–π —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.
    - –ü—Ä–∞–≤–æ –Ω–∞ –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ ‚Äî –æ–¥–∏–Ω –ø–∏—Ä–æ–∂–æ–∫ –Ω–µ ¬´–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞¬ª. –ü–æ–¥–¥–µ—Ä–∂–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.
    - –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Ç–æ—á–Ω—è–π –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, –≤–µ—Å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ü–µ–ª–∏.
    - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä ‚Äî –ø—Ä–∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö —Å–æ–≤–µ—Ç—É–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É –∏–ª–∏ –¥–∏–µ—Ç–æ–ª–æ–≥—É.

    –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–ø–ª–∏–∫:
    - ¬´–ù—É —á—Ç–æ, –ø–æ—Å–º–æ—Ç—Ä–∏–º, —Å–∫–æ–ª—å–∫–æ –≤–∫—É—Å–Ω–æ–≥–æ —Ç—ã —Å–µ–≥–æ–¥–Ω—è —Å—ä–µ–ª–∞? üòä¬ª
    - ¬´–í—Å—ë –≤ –Ω–æ—Ä–º–µ. –ú–æ–∂–Ω–æ —Å—ä–µ—Å—Ç—å –µ—â—ë —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–∫—É—Å–Ω–µ–Ω—å–∫–æ–µ üíõ¬ª
    - ¬´–ù–µ —Å—Ç—Ä–∞—à–Ω–æ, —á—Ç–æ —Å—ä–µ–ª–∞ –ø–∏—Ä–æ–∂–æ–∫. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å, –∞ —è —Ä—è–¥–æ–º¬ª.
    - ¬´–§–æ—Ç–∫–∞ –æ—Ç–ª–∏—á–Ω–∞—è! –ö–ë–ñ–£ –ø–æ—Å—á–∏—Ç–∞–ª–∞, –µ—â—ë 250 –∫–∫–∞–ª –≤ –∑–∞–ø–∞—Å–µ ‚Äî –º–æ–∂–Ω–æ —è–±–ª–æ–∫–æ –∏–ª–∏ –π–æ–≥—É—Ä—Ç¬ª.

    –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ:
    - –î–∞–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏–ª–∏ –ª–µ—á–µ–±–Ω—ã–µ —Å—Ö–µ–º—ã.
    - –ü—É–≥–∞—Ç—å, —Å—Ç—ã–¥–∏—Ç—å, —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å ¬´–∏–¥–µ–∞–ª–æ–º¬ª.
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
    - –ü—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –¥–∏–µ—Ç—ã, –¥–µ—Ç–æ–∫—Å—ã, –∑–∞–ø—Ä–µ—Ç—ã —Ü–µ–ª—ã—Ö –≥—Ä—É–ø–ø –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
    """

    SYSTEM_PROMPT_NUTRITION = SYSTEM_PROMPT_FOOD

    # –¶–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    SUBSCRIPTION_PRICE = int(os.getenv("SUBSCRIPTION_PRICE", "399"))

    # --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ ---
    SUBSCRIPTION_DAYS = int(os.getenv("SUBSCRIPTION_DAYS", "30"))
    FREE_PHOTO_LIMIT = int(os.getenv("FREE_PHOTO_LIMIT", "5"))
    FREE_QUESTION_LIMIT = int(os.getenv("FREE_QUESTION_LIMIT", "10"))

    # –î–∞–Ω–Ω—ã–µ –ÆKassa (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏)
    YOOKASSA_SHOP_ID = os.getenv("YOOKASSA_SHOP_ID")
    YOOKASSA_SECRET_KEY = os.getenv("YOOKASSA_SECRET_KEY")

    # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
    ADMIN_ID = int(os.getenv("ADMIN_ID", "780848273"))

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
config = Config()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
if not config.SYSTEM_PROMPT_FOOD or len(config.SYSTEM_PROMPT_FOOD.strip()) < 10:
    logger.warning("–í–ù–ò–ú–ê–ù–ò–ï! –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –µ–¥—ã –ø—É—Å—Ç –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")

if not config.SYSTEM_PROMPT_NUTRITION or len(config.SYSTEM_PROMPT_NUTRITION.strip()) < 10:
    logger.warning("–í–ù–ò–ú–ê–ù–ò–ï! –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –æ –ø–∏—Ç–∞–Ω–∏–∏ –ø—É—Å—Ç –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")

logger.info(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å: {config.CLAUDE_MODEL}")
